<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×ª×™×¢×•×“ ×˜××¤×¨×˜×•×¨×•×ª ×¡×•×œ×œ×•×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent: #2563eb;
      --danger: #dc2626;
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
    }

    .header {
      margin-top: 8px;
      border-radius: var(--radius);
      border: 1px solid #d1d5db;
      background: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      flex: 1;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-button {
      border: none;
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      font-size: 16px;
    }

    .card {
      margin-top: 10px;
      border-radius: 14px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 12px;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .field {
      margin-bottom: 8px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .buttons-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    button.primary {
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
    }

    button.secondary {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
    }

    button.warn {
      background: #f97316;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 15px;
      cursor: pointer;
    }

    button.outline {
      background: #e5e7eb;
      color: #111827;
      border: none;
      border-radius: 8px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .stats-card {
      margin-top: 10px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.4;
    }

    .table-container {
      margin-top: 10px;
      background: #f3f4f6;
      border-radius: 12px;
      padding: 6px;
      max-height: 420px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead tr {
      position: sticky;
      top: 0;
      background: #e5e7eb;
      z-index: 1;
    }

    th, td {
      padding: 6px 4px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tr.high-temp {
      background: #fee2e2;
      color: #b91c1c;
    }

    .filter-bar {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .filter-bar button {
      flex: 1;
    }

    /* ××¡×š ×¡×™× ×•×Ÿ ××œ× (××•×‘×¨×œ×™×™) */

    .filter-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .filter-panel {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      background: #f9fafb;
      box-shadow: 0 18px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .filter-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .filter-title {
      flex: 1;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
    }

    .filter-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      color: #2563eb;
    }

    .filter-list {
      flex: 1;
      overflow: auto;
      background: #f9fafb;
    }

    .filter-item {
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-item:hover {
      background: #e5e7eb;
    }

    .filter-item.active {
      background: #dbeafe;
      font-weight: 600;
      color: #1d4ed8;
    }

    .filter-badge {
      font-size: 12px;
      color: #6b7280;
    }

    @media (max-width: 600px) {
      .app {
        padding: 8px;
      }
      .header-title {
        font-size: 18px;
      }
      .card h2 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ×›×•×ª×¨×ª ×¢×œ×™×•× ×” -->
    <div class="header">
      <div class="header-actions">
        <!-- ××¤×©×¨ ×œ×”×¨×—×™×‘ ×‘×¢×ª×™×“ -->
      </div>
      <div class="header-title">×ª×™×¢×•×“ ×˜××¤×¨×˜×•×¨×•×ª ×¡×•×œ×œ×•×ª</div>
      <div class="header-actions">
        <!-- ×©××¨×ª×™ ××§×•× ×œ×›×¤×ª×•×¨×™ ××¦×‘ ×œ×™×œ×” ×‘×¢×ª×™×“ -->
      </div>
    </div>

    <!-- ×›×¨×˜×™×¡ ×˜×•×¤×¡ -->
    <div class="card">
      <h2>×”×•×¡×¤×ª ×¨×©×•××”</h2>
      <div class="field">
        <label>××¡×¤×¨ ×¡×•×œ×œ×”</label>
        <input id="battery-number" type="text" />
      </div>
      <div class="field">
        <label>×˜××¤' ×”×ª×—×œ×” (Â°C)</label>
        <input id="start-temp" type="number" step="0.1" />
      </div>
      <div class="field">
        <label>×©×¢×ª ×ª×—×™×œ×ª ×˜×¢×™× ×” (×œ× ×—×•×‘×”, HH:MM)</label>
        <input id="start-time" type="text" placeholder="×œ×“×•×’××” 10:30" />
      </div>
      <div class="field">
        <label>×˜××¤' ××—×¨×™ 2×© (×œ× ×—×•×‘×”)</label>
        <input id="temp-after" type="number" step="0.1" />
      </div>
      <div class="field">
        <label>×©×¢×ª ×‘×“×™×§×” ×©× ×™×™×” (×œ× ×—×•×‘×”)</label>
        <input id="time-after" type="text" placeholder="×œ×“×•×’××” 12:30" />
      </div>

      <div class="buttons-row">
        <button class="primary" id="add-record-btn">â• ×”×•×¡×£ ×¨×©×•××”</button>
        <button class="secondary" id="reminder-btn">â° ×ª×–×›×•×¨×•×ª ×›×œ ×©×¢×” (×“×¤×“×¤×Ÿ)</button>
        <button class="warn" id="export-csv-btn">ğŸ“¤ ×™×™×¦×•× ×œ-CSV</button>
        <button class="outline" id="export-report-btn">ğŸ“„ ×“×•×— ×˜×§×¡×˜ (PDF ×“×¨×š ×”×“×¤×¡×”)</button>
      </div>
    </div>

    <!-- ×¤×¡ ×¡×™× ×•×Ÿ -->
    <div class="filter-bar">
      <button class="outline" id="filter-open-btn">×¡×™× ×•×Ÿ: ×”×›×œ</button>
      <button class="outline" id="clear-data-btn">× ×§×” × ×ª×•× ×™× (×‘×“×¤×“×¤×Ÿ)</button>
    </div>

    <!-- ×›×¨×˜×™×¡ ×¡×˜×˜×™×¡×˜×™×§×•×ª -->
    <div class="stats-card" id="stats-box">
      ××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”
    </div>

    <!-- ×˜×‘×œ×” -->
    <div class="table-container">
      <table id="data-table">
        <thead>
          <tr>
            <th>××¡' ×¡×•×œ×œ×”</th>
            <th>×˜××¤' ×”×ª×—×œ×”</th>
            <th>×ª××¨×™×š + ×©×¢×ª ×”×ª×—×œ×”</th>
            <th>×˜××¤' ××—×¨×™ 2×©</th>
            <th>×©×¢×ª ×‘×“×™×§×” ×©× ×™×™×”</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ××•×‘×¨×œ×™×™ ×¡×™× ×•×Ÿ ××œ× -->
  <div class="filter-overlay" id="filter-overlay">
    <div class="filter-panel">
      <div class="filter-header">
        <button class="filter-close" id="filter-close-btn">×¡×’×•×¨</button>
        <div class="filter-title">×‘×—×¨ ×¡×•×œ×œ×” ×œ×¡×™× ×•×Ÿ</div>
        <div style="width:70px;"></div>
      </div>
      <div class="filter-list" id="filter-list"></div>
    </div>
  </div>

  <script>
    // ------- × ×ª×•× ×™× ×•×–×™×›×¨×•×Ÿ ×‘×“×¤×“×¤×Ÿ --------
    const STORAGE_KEY = 'battery_records_v1';

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    function saveRecords(records) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    // ------- ××œ×× ×˜×™× DOM --------
    const batteryNumberInput = document.getElementById('battery-number');
    const startTempInput = document.getElementById('start-temp');
    const startTimeInput = document.getElementById('start-time');
    const tempAfterInput = document.getElementById('temp-after');
    const timeAfterInput = document.getElementById('time-after');

    const addRecordBtn = document.getElementById('add-record-btn');
    const reminderBtn = document.getElementById('reminder-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportReportBtn = document.getElementById('export-report-btn');

    const tableBody = document.querySelector('#data-table tbody');
    const statsBox = document.getElementById('stats-box');

    const filterOpenBtn = document.getElementById('filter-open-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');

    const filterOverlay = document.getElementById('filter-overlay');
    const filterList = document.getElementById('filter-list');
    const filterCloseBtn = document.getElementById('filter-close-btn');

    // ××¦×‘ ××¤×œ×™×§×¦×™×”
    let allRecords = loadRecords();
    let currentFilter = '×”×›×œ';

    // ------- ×¨×™× ×“×•×¨ ×˜×‘×œ×” --------
    function renderTable() {
      tableBody.innerHTML = '';
      const recs = getFilteredRecords();
      recs.forEach(rec => {
        const tr = document.createElement('tr');

        const tempAfter = rec.temp_after;
        let high = false;
        const val = parseFloat(tempAfter);
        if (!isNaN(val) && val > 40) high = true;
        if (high) tr.classList.add('high-temp');

        tr.innerHTML = `
          <td>${rec.battery_number || ''}</td>
          <td>${rec.start_temp ?? ''}</td>
          <td>${rec.start_datetime || ''}</td>
          <td>${rec.temp_after ?? ''}</td>
          <td>${rec.time_after || ''}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // ------- ×¡×˜×˜×™×¡×˜×™×§×•×ª --------
    function updateStats() {
      const recs = getFilteredRecords();
      if (!recs.length) {
        statsBox.textContent = '××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”';
        return;
      }

      const total = recs.length;
      const uniq = new Set(recs.map(r => r.battery_number || '')).size;
      let highs = 0;
      const startTemps = [];
      const afterTemps = [];
      let maxAfter = null;

      recs.forEach(r => {
        const st = parseFloat(r.start_temp);
        if (!isNaN(st)) startTemps.push(st);

        const ta = parseFloat(r.temp_after);
        if (!isNaN(ta)) {
          afterTemps.push(ta);
          if (ta > 40) highs++;
          if (maxAfter === null || ta > maxAfter) maxAfter = ta;
        }
      });

      const avgStart = startTemps.length
        ? (startTemps.reduce((a, b) => a + b, 0) / startTemps.length)
        : null;
      const avgAfter = afterTemps.length
        ? (afterTemps.reduce((a, b) => a + b, 0) / afterTemps.length)
        : null;

      const parts = [
        `×¡×”"×› ×¨×©×•××•×ª: ${total}`,
        `××¡×¤×¨ ×¡×•×œ×œ×•×ª ×©×•× ×•×ª: ${uniq}`,
        `×—×¨×™×’×•×ª ××¢×œ 40Â°C: ${highs}`
      ];
      if (avgStart !== null || avgAfter !== null) {
        parts.push(
          `×××•×¦×¢ ×”×ª×—×œ×”: ${avgStart !== null ? avgStart.toFixed(1) + 'Â°C' : '-'} | ` +
          `×××•×¦×¢ ××—×¨×™ 2×©: ${avgAfter !== null ? avgAfter.toFixed(1) + 'Â°C' : '-'}`
        );
      }
      if (maxAfter !== null) {
        parts.push(`××§×¡×™××•× ××—×¨×™ 2×©: ${maxAfter.toFixed(1)}Â°C`);
      }

      statsBox.innerHTML = parts.join('<br>');
    }

    function getFilteredRecords() {
      if (currentFilter === '×”×›×œ') return allRecords.slice();
      return allRecords.filter(r => String(r.battery_number) === currentFilter);
    }

    // ------- ×”×•×¡×¤×ª ×¨×©×•××” --------
    addRecordBtn.addEventListener('click', () => {
      const b = batteryNumberInput.value.trim();
      const t1Str = startTempInput.value.trim();
      const startTime = startTimeInput.value.trim();
      const t2Str = tempAfterInput.value.trim();
      const time2 = timeAfterInput.value.trim();

      if (!b || !t1Str) {
        alert("×—×•×‘×” ×œ××œ× ××¡×¤×¨ ×¡×•×œ×œ×” ×•×˜××¤' ×”×ª×—×œ×”");
        return;
      }

      const t1 = parseFloat(t1Str);
      if (isNaN(t1)) {
        alert("×˜××¤' ×”×ª×—×œ×” ×œ× ××¡×¤×¨");
        return;
      }

      let t2 = '';
      if (t2Str) {
        const val = parseFloat(t2Str);
        if (isNaN(val)) {
          alert("×˜××¤' ××—×¨×™ 2×© ×œ× ××¡×¤×¨");
          return;
        }
        t2 = val.toFixed(1);
        if (val > 40) {
          alert('××–×”×¨×”: ×˜××¤×¨×˜×•×¨×” ××—×¨×™ 2 ×©×¢×•×ª ××¢×œ 40Â°C! ×‘×“×•×§ ××™×“ ××ª ×”×¡×•×œ×œ×”.');
        }
      }

      let startDt;
      if (startTime) {
        const dateStr = new Date().toLocaleDateString('he-IL');
        startDt = `${dateStr} ${startTime}`;
      } else {
        const now = new Date();
        const dateStr = now.toLocaleDateString('he-IL');
        const timeStr = now.toTimeString().substring(0,5);
        startDt = `${dateStr} ${timeStr}`;
      }

      const rec = {
        battery_number: b,
        start_temp: t1.toFixed(1),
        start_datetime: startDt,
        start_time: startTime,
        temp_after: t2,
        time_after: time2
      };

      allRecords.push(rec);
      saveRecords(allRecords);
      renderTable();
      updateStats();
      updateFilterButtonLabel();

      batteryNumberInput.value = '';
      startTempInput.value = '';
      startTimeInput.value = '';
      tempAfterInput.value = '';
      timeAfterInput.value = '';
    });

    // ------- ×™×™×¦×•× CSV --------
    exportCsvBtn.addEventListener('click', () => {
      if (!allRecords.length) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×¦×•×');
        return;
      }
      const rows = [];
      rows.push([
        'Battery Number',
        'Start Temp (C)',
        'Start DateTime',
        'Charge Start Time',
        'Temp After 2h (C)',
        'Second Check Time'
      ]);
      getFilteredRecords().forEach(r => {
        rows.push([
          r.battery_number || '',
          r.start_temp || '',
          r.start_datetime || '',
          r.start_time || '',
          r.temp_after || '',
          r.time_after || ''
        ]);
      });

      const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'battery_export.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ------- ×“×•×— ×˜×§×¡×˜ --------
    exportReportBtn.addEventListener('click', () => {
      const recs = getFilteredRecords();
      if (!recs.length) {
        alert('××™×Ÿ × ×ª×•× ×™× ×œ×“×•×—');
        return;
      }
      updateStats();
      const statsText = statsBox.innerText;

      let content = '×“×•×— ×˜××¤×¨×˜×•×¨×•×ª ×¡×•×œ×œ×•×ª\n';
      content += '----------------------------------------\n\n';
      content += statsText + '\n\n';
      content += '×¨×©×•××•×ª:\n';
      content += '××¡×¤×¨\t×”×ª×—×œ×”[Â°C]\t×ª××¨×™×š-×©×¢×”\t×©×¢×ª ×”×ª×—×œ×”\t××—×¨×™ 2×©[Â°C]\t×©×¢×” 2\n';
      recs.forEach(r => {
        content += `${r.battery_number}\t${r.start_temp}\t${r.start_datetime}\t${r.start_time || ''}\t${r.temp_after || ''}\t${r.time_after || ''}\n`;
      });

      const blob = new Blob([content], {type: 'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'battery_report.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ------- ×ª×–×›×•×¨×•×ª ×›×œ ×©×¢×” (×‘×’×¡×•×ª) --------
    reminderBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) {
        alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
        return;
      }
      let perm = Notification.permission;
      if (perm === 'default') {
        perm = await Notification.requestPermission();
      }
      if (perm !== 'granted') {
        alert('×”×”×¨×©××” ×œ×”×ª×¨××•×ª × ×—×¡××”');
        return;
      }
      alert('×”×—×œ ××”×©×¢×” ×”×§×¨×•×‘×” ×ª×•×¤×™×¢ ×”×ª×¨××” ×›×œ ×©×¢×” ×›×œ ×¢×•×“ ×”×“×£ ×¤×ª×•×—.');

      setInterval(() => {
        new Notification('×‘×“×™×§×ª ×¡×•×œ×œ×•×ª', {
          body: '×–××Ÿ ×œ×‘×“×•×§ ×˜××¤×¨×˜×•×¨×•×ª ×œ×¡×•×œ×œ×•×ª ×•×œ×ª×¢×“ ×‘×˜×‘×œ×”.',
        });
      }, 60 * 60 * 1000);
    });

    // ------- × ×§×” × ×ª×•× ×™× --------
    clearDataBtn.addEventListener('click', () => {
      if (!confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ××”×“×¤×“×¤×Ÿ?')) return;
      allRecords = [];
      saveRecords(allRecords);
      renderTable();
      updateStats();
      updateFilterButtonLabel();
    });

    // ------- ××¡×š ×¡×™× ×•×Ÿ ××œ× --------
    function updateFilterButtonLabel() {
      filterOpenBtn.textContent = `×¡×™× ×•×Ÿ: ${currentFilter}`;
    }

    function openFilterOverlay() {
      const numsSet = new Set(allRecords.map(r => String(r.battery_number || '').trim()).filter(Boolean));
      const nums = Array.from(numsSet).sort((a, b) => a.localeCompare(b, 'he-IL', {numeric:true}));
      const options = ['×”×›×œ', ...nums];

      filterList.innerHTML = '';
      options.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'filter-item';
        if (opt === currentFilter) div.classList.add('active');
        div.innerHTML = `
          <span>${opt}</span>
          <span class="filter-badge">
            ${opt === '×”×›×œ'
              ? allRecords.length + ' ×¨×©×•××•×ª'
              : allRecords.filter(r => String(r.battery_number) === opt).length + ' ×¨×©×•××•×ª'
            }
          </span>
        `;
        div.addEventListener('click', () => {
          currentFilter = opt;
          closeFilterOverlay();
          renderTable();
          updateStats();
          updateFilterButtonLabel();
        });
        filterList.appendChild(div);
      });

      filterOverlay.style.display = 'flex';
    }

    function closeFilterOverlay() {
      filterOverlay.style.display = 'none';
    }

    filterOpenBtn.addEventListener('click', openFilterOverlay);
    filterCloseBtn.addEventListener('click', closeFilterOverlay);
    filterOverlay.addEventListener('click', e => {
      if (e.target === filterOverlay) closeFilterOverlay();
    });

    // ------- ××ª×—×•×œ ×¨××©×•× ×™ --------
    renderTable();
    updateStats();
    updateFilterButtonLabel();
  </script>
</body>
</html>